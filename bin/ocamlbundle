#!/bin/bash

set -euo pipefail

script_dir="$(cd "$(dirname "$0")" && pwd)"
cat_parsetree="${CAT_PARSETREE:-$script_dir/cat_parsetree.exe}"

read_file() {
  if [[ "$1" == *.pp.ml ]] || [[ "$1" == *.pp.mli ]]; then
    "$cat_parsetree" "$1"
  else
    cat "$1"
  fi
}

echo "(* THIS FILE WAS AUTOMATICALLY GENERATED BY CAT'ING LIBRARY SOURCES *)"
echo '[@@@ocaml.warning "-27-32-35"]' # so it builds with default dune settings

for module in $(ocamldep "$@" -sort); do
[[ "$module" == *.mli ]] && continue
modname="$module"
modname=$(basename "$modname" .pp.ml)
modname=$(basename "$modname" .pp.mli)
modname=$(basename "$modname" .ml)
modname=$(basename "$modname" .mli)
modname=$(echo "$modname" | awk '{print toupper(substr($0,1,1)) substr($0,2)}')
iface="${module%.ml}.mli"

if [ -f "$iface" ]; then
echo "module ${modname} : sig
$(read_file "$iface")
end = struct
$(read_file "$module")
end"

else
echo "module ${modname} = struct
$(read_file "$module")
end"
fi

done
