Isolate mach config to a test dir:
  $ . ../env.sh

This test is only valid for the ninja build backend.
Skip the test if we're using make backend:
  $ if ! grep -q 'build-backend "ninja"' Mach; then echo "SKIP: not ninja backend"; exit 0; fi

Prepare source files:
  $ cat << 'EOF' > lib.ml
  > let greet name = Printf.printf "Hello, %s!\n" name
  > EOF

  $ cat << 'EOF' > main.ml
  > #require "./lib"
  > let () = Lib.greet "World"
  > EOF

Test with ninja backend (filter out ninja's progress output):
  $ mach run ./main.ml 2>&1 | grep -v "^\[" | grep -v "^ninja:"
  Hello, World!

Inspect the build dir - check for ninja files instead of Makefile:
  $ ls _mach/build/*__lib.ml | sort
  includes.args
  lib.cmi
  lib.cmt
  lib.cmx
  lib.ml
  lib.o
  mach.ninja

  $ ls _mach/build/*__main.ml | sort
  Mach.state
  a.out
  all_objects.args
  build.ninja
  includes.args
  mach.ninja
  main.cmi
  main.cmt
  main.cmx
  main.ml
  main.o

Check build.ninja uses subninja to include the dependency:
  $ grep -q "subninja.*mach.ninja" _mach/build/*__main.ml/build.ninja && echo "includes dependency"
  includes dependency

Verify mach.ninja has the cmd rule (each file has its own scoped rules):
  $ grep -q "^rule cmd" _mach/build/*__lib.ml/mach.ninja && echo "has cmd rule"
  has cmd rule
