# Refactoring: Move includes.args generation / preprocessing to Makefile

## Goal

Move the preprocessing and `includes.args`/`objects.args` generation from the initial mach setup phase into make targets. This will allow make to track when source files change and only re-preprocess/regenerate args when needed.

## Current Architecture

Currently in `run`:
1. `resolve_deps` collects all dependencies via DFS, parsing and preprocessing each source file
2. For each dependency, we write:
   - `<build-dir>/<module>.ml` (preprocessed source)
   - `<build-dir>/includes.args` (with `-I` lines for immediate deps)
3. For the main script, we write the same files plus `objects.args` (all .cmo files in topo order)
4. We generate a `Makefile` with compile/link rules
5. We run make

The problem: All preprocessing happens before make runs. If a source file changes, we need to re-run the entire mach command from scratch.

## Proposed Architecture

### New subcommand: `mach configure <src-mod.ml>`

This subcommand will:
1. Parse `<src-mod.ml>` for `[%%require ...]` directives
2. Preprocess the source (remove require directives)
3. Write to the module's build directory:
   - `<module>.ml` - preprocessed source
   - `includes.args` - `-I` lines for each immediate dependency's build dir
   - `objects.args` - `.cmo` lines for each immediate dependency (NOT transitive)

### Updated Makefile generation

For each module, generate targets like:

```makefile
# Configure target - runs mach configure to generate preprocessed source and args files
<build-dir>/<module>.ml: <src-path>
	mach configure <src-path> -o <build-dir>

# These are generated by configure, depend on the preprocessed .ml
<build-dir>/includes.args: <build-dir>/<module>.ml
<build-dir>/objects.args: <build-dir>/<module>.ml

# Compile target - depends on preprocessed source, includes.args, and dependency .cmi files
<build-dir>/<module>.cmo: <build-dir>/<module>.ml <build-dir>/includes.args <dep1-build-dir>/<dep1>.cmi ...
	ocamlc -c -args <build-dir>/includes.args -o $@ $<

<build-dir>/<module>.cmi: <build-dir>/<module>.cmo
```

For the main script, we need to merge all objects.args:

```makefile
<build-dir>/all_objects.args: <build-dir>/objects.args <dep1-build-dir>/objects.args ...
	awk '!seen[$$0]++' $^ > $@

<build-dir>/a.out: <all cmos...> <build-dir>/all_objects.args
	ocamlc -o $@ -args <build-dir>/all_objects.args
```

## Implementation Steps

### Step 1: Add `mach configure` subcommand

Add a new Cmdliner subcommand that:
- Takes a source path as argument
- Parses and preprocesses the source (reuse `parse_and_preprocess`)
- Resolves the require paths to absolute paths
- Computes the build directory using `default_build_dir`
- Writes:
  - `<module>.ml` - preprocessed source
  - `includes.args` - one `-I\n<path>` pair per immediate dependency
  - `objects.args` - one `.cmo` path per immediate dependency (NOT transitive)

### Step 2: Update Makefile generation

Modify `Makefile` module:
1. Add `configure_rule` function to generate the configure target
2. Update `compile_ocaml_module` to depend on `includes.args` (it already does) and the configure target
3. Add `all_objects_args_rule` function to merge objects.args files (TODO: no need to separate function, simple enough to do via rule)
4. Update `link_ocaml_module` to use `all_objects.args`

### Step 3: Update `run` command

Modify the `run` function:
1. Still do initial DFS to collect all dependencies (needed to generate Makefile)
2. Remove the code that writes `includes.args`, `objects.args`, and preprocessed sources
3. Update Makefile generation to include configure targets
4. Let make handle calling `mach configure` for each module

### Step 4: Update tests

Update `test/test_simple.t` to verify the new behavior:
- Build directory should still contain the same files
- `objects.args` in dependency directories should only list immediate deps
- New `all_objects.args` in main script's build directory

## Design Considerations

### Objects.args scope change

Currently `objects.args` lists ALL .cmo files in topological order. With this change:
- Each module's `objects.args` will only list its **immediate** dependencies' .cmo files
- A new `all_objects.args` will merge all objects.args files, deduplicating

The awk command `awk '!seen[$0]++'` preserves order while removing duplicates, which maintains topological order when processing files in dependency order.

### Dependency on configure outputs

The key insight is that `includes.args` and `objects.args` are generated as a side effect of writing the preprocessed `.ml` file. So we make them depend on the `.ml` file (as a marker that configure ran).

### First run vs incremental

On first run:
1. `run` does DFS to discover all modules
2. Generates Makefile with configure targets
3. Make calls `mach configure` for each module
4. Make compiles and links

On subsequent runs (source unchanged):
1. `run` does DFS (this is the overhead we can't avoid - need to know what to build)
2. Generates Makefile (may be identical)
3. Make sees all targets are up-to-date
4. No recompilation

On incremental change (one source changed):
1. `run` does DFS
2. Generates Makefile
3. Make sees source changed, runs `mach configure` for that module
4. Make recompiles affected modules

### Edge case: new dependency added

If a source file adds a new `[%%require ...]`:
1. `run` does DFS - discovers new dependency
2. Generates updated Makefile with new module's rules
3. Make runs `mach configure` for modified source
4. Make compiles new dependency and re-links

This works because we regenerate the Makefile on every run.

## Files to modify

- `bin/main.ml`:
  - Add `configure` subcommand and `configure_cmd` function
  - Update `Makefile` module with new rules
  - Update `run` to not write files directly (let make do it via configure)

- `test/test_simple.t`:
  - Update expected build directory contents
  - May need to check `objects.args` vs `all_objects.args`

## Implementation Summary (Completed)

### Changes Made

1. **Added `mach configure` subcommand** (`bin/main.ml:221-255`)
   - Takes source path and optional `-o` output directory
   - Parses source for `[%%require ...]` directives using existing `parse_and_preprocess`
   - Writes to build directory:
     - `<module>.ml` - preprocessed source (require directives removed)
     - `includes.args` - `-I` lines for each immediate dependency's build dir
     - `objects.args` - immediate dependencies' `.cmo` files + self

2. **Updated `Makefile` module** (`bin/main.ml:152-219`)
   - Added `configure_ocaml_module` function generating:
     - `<build>.ml: <src>` target calling `mach configure`
     - `includes.args: <build>.ml` and `objects.args: <build>.ml` marker targets
   - Updated `compile_ocaml_module` to depend on `includes.args`
   - Updated `link_ocaml_module` to:
     - Generate `all_objects.args` by merging all `objects.args` with `awk '!seen[$0]++'`
     - Link using `all_objects.args`

3. **Simplified `run` function** (`bin/main.ml:257-310`)
   - Removed direct file writes (write_includes_args, write_file for sources, objects.args)
   - Now only generates Makefile with configure/compile/link targets
   - Make handles all file generation via configure targets

### Key Design Decision

Each module's `objects.args` includes its own `.cmo` as the last entry (not just immediate deps). This ensures that when merging in topological order, all modules are included in the final `all_objects.args`.

### Test Updates

All tests updated to expect:
- New `all_objects.args` file in main script's build directory
- New `objects.args` file in dependency build directories
- Verbose output showing `mach configure` and `awk` commands
